<!DOCTYPE html>
<html>
<head>
    <title>Test Comunidades Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>üîç Diagn√≥stico: Comunidades en Firebase</h1>
    <button onclick="testComunidades()" style="padding: 15px 30px; font-size: 18px; cursor: pointer;">
        üöÄ Probar Conexi√≥n y Cargar Comunidades
    </button>
    <div id="results" style="margin-top: 20px; font-size: 16px;"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDfAVsv5Mz8COqTem5E-KkbFaW92pvvBfo",
            authDomain: "rps-claim-manager-1f250.firebaseapp.com",
            projectId: "rps-claim-manager-1f250",
            storageBucket: "rps-claim-manager-1f250.firebasestorage.app",
            messagingSenderId: "99995806902",
            appId: "1:99995806902:android:6c4aa7405e1cc447410a17"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function testComunidades() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>üîÑ Conectando a Firebase...</p>';

            try {
                console.log('Intentando leer comunidades...');
                const snapshot = await db.collection('comunidades').get();
                
                console.log('Snapshot recibido:', snapshot.size, 'documentos');
                
                if (snapshot.empty) {
                    results.innerHTML = `
                        <h2>‚ö†Ô∏è NO HAY COMUNIDADES</h2>
                        <p><strong>Problema encontrado:</strong> La colecci√≥n 'comunidades' existe pero est√° vac√≠a.</p>
                        <h3>üìù Soluci√≥n:</h3>
                        <ol>
                            <li>Ve a: <a href="https://rps-control-tiempos.netlify.app" target="_blank">https://rps-control-tiempos.netlify.app</a></li>
                            <li>Click en "Comunidades"</li>
                            <li>Click en "+ Nueva Comunidad"</li>
                            <li>Crea al menos 2-3 comunidades</li>
                        </ol>
                    `;
                    return;
                }

                const comunidades = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    comunidades.push({
                        id: doc.id,
                        nombre: data.nombre || 'SIN NOMBRE',
                        direccion: data.direccion || 'N/A',
                        ciudad: data.ciudad || 'N/A',
                        codigoPostal: data.codigoPostal || 'N/A'
                    });
                });

                results.innerHTML = `
                    <h2>‚úÖ COMUNIDADES ENCONTRADAS: ${comunidades.length}</h2>
                    <h3>üìã Lista de Comunidades:</h3>
                    <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%;">
                        <tr style="background: #1976D2; color: white;">
                            <th>Nombre</th>
                            <th>Direcci√≥n</th>
                            <th>Ciudad</th>
                            <th>CP</th>
                        </tr>
                        ${comunidades.map(c => `
                            <tr>
                                <td><strong>${c.nombre}</strong></td>
                                <td>${c.direccion}</td>
                                <td>${c.ciudad}</td>
                                <td>${c.codigoPostal}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <br>
                    <p style="color: green;"><strong>‚úÖ Las comunidades existen en Firebase.</strong></p>
                    <p>Si a√∫n no aparecen en tus apps, verifica:</p>
                    <ol>
                        <li>Que las URLs de tus apps est√©n autorizadas en Firebase Authentication</li>
                        <li>Que hayas recargado las apps (Ctrl+F5)</li>
                        <li>Que no haya errores en la consola del navegador (F12)</li>
                    </ol>
                `;

            } catch (error) {
                console.error('Error:', error);
                results.innerHTML = `
                    <h2>‚ùå ERROR AL CONECTAR</h2>
                    <p><strong>Tipo de error:</strong> ${error.code}</p>
                    <p><strong>Mensaje:</strong> ${error.message}</p>
                    <br>
                    <h3>üîß Posibles Soluciones:</h3>
                    ${error.code === 'permission-denied' ? `
                        <p style="color: red;"><strong>PROBLEMA DE PERMISOS</strong></p>
                        <p>Las reglas de Firestore est√°n bloqueando el acceso.</p>
                        <ol>
                            <li>Ve a: <a href="https://console.firebase.google.com/project/rps-claim-manager-1f250/firestore/rules" target="_blank">Firebase Rules</a></li>
                            <li>Verifica que exista esta regla:</li>
                        </ol>
                        <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
match /comunidades/{document=**} {
  allow read, write: if true;
}</pre>
                    ` : `
                        <p>Error inesperado. Revisa la consola del navegador para m√°s detalles.</p>
                    `}
                `;
            }
        }

        // Auto-ejecutar al cargar la p√°gina
        window.onload = function() {
            setTimeout(testComunidades, 1000);
        };
    </script>
</body>
</html>
